name: MapLibre Compatibility

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run weekly on Sunday at midnight to catch new MapLibre releases
    - cron: '0 0 * * 0'

concurrency:
  group: maplibre-compat-${{ github.ref }}
  cancel-in-progress: true

jobs:
  compatibility-matrix:
    name: MapLibre v${{ matrix.maplibre-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        maplibre-version:
          - '3.6.0'   # Minimum supported version
          - '4.0.0'   # Major version 4.x
          - '4.5.0'   # Mid 4.x release
          - '5.0.0'   # Major version 5.x (if available)
          - 'latest'  # Always test latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Override MapLibre version
        run: |
          if [ "${{ matrix.maplibre-version }}" != "latest" ]; then
            npm install maplibre-gl@${{ matrix.maplibre-version }} --save-dev --legacy-peer-deps
          fi

      - name: Show installed MapLibre version
        run: npm list maplibre-gl

      - name: Run TypeScript type check
        run: npm run typecheck
        continue-on-error: ${{ matrix.maplibre-version == '5.0.0' }}

      - name: Run unit tests
        run: npm test -- --reporter=verbose
        continue-on-error: ${{ matrix.maplibre-version == '5.0.0' }}

      - name: Build library
        run: npm run build

      - name: Test import compatibility
        run: |
          cat > test-import.mjs << 'EOF'
          import maplibregl from 'maplibre-gl';
          import { ShaderManager, globalRegistry } from './packages/lib/dist/index.js';

          console.log('MapLibre version:', maplibregl.version || 'unknown');
          console.log('ShaderManager:', typeof ShaderManager);
          console.log('globalRegistry:', typeof globalRegistry);
          console.log('Registry has:', globalRegistry.list().length, 'shaders');

          // Test that core exports work
          if (typeof ShaderManager !== 'function') {
            throw new Error('ShaderManager is not a function');
          }
          if (typeof globalRegistry.get !== 'function') {
            throw new Error('globalRegistry.get is not a function');
          }

          console.log('✓ All imports work correctly');
          EOF
          node test-import.mjs
          rm test-import.mjs

  report:
    name: Compatibility Report
    runs-on: ubuntu-latest
    needs: compatibility-matrix
    if: always()
    steps:
      - name: Generate compatibility report
        run: |
          echo "## MapLibre Compatibility Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| MapLibre Version | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 3.6.0 (min)      | ${{ needs.compatibility-matrix.result == 'success' && '✅' || '⚠️' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 4.0.0            | ${{ needs.compatibility-matrix.result == 'success' && '✅' || '⚠️' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 4.5.0            | ${{ needs.compatibility-matrix.result == 'success' && '✅' || '⚠️' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| 5.0.0            | ${{ needs.compatibility-matrix.result == 'success' && '✅' || '⚠️' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| latest           | ${{ needs.compatibility-matrix.result == 'success' && '✅' || '⚠️' }} |" >> $GITHUB_STEP_SUMMARY
